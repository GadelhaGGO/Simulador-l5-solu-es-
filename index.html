<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Simulador Linha 5 Lil√°s</title>
  
  <style>
    /* Container para as colunas de status */
.status-container {
  display: flex;
  flex-wrap: wrap;
  gap: 20px;
  justify-content: space-around;
}

.status-col {
  flex: 1;
  min-width: 200px;
}

/* Trem com falha: piscar */
.trem-falha {
  animation: piscar 0.5s infinite alternate;
}.btn-inserir-trem {
      background: #00bfa5;
      color: white;
    }
    body {
      font-family: Arial;
      background: #eef;
      text-align: center;
      padding: 20px;
      overflow-x: hidden;
    }
    .container {
      max-width: 100%;
      margin: 0 auto;
    }
    .linha-container {
      width: 100vw;
      overflow-x: auto;
      padding: 20px 0;
      margin: 20px 0;
      display: flex;
      justify-content: center;
      align-items: center;
    }
    .linha {
      display: flex;
      min-width: 1100px;
      justify-content: center;
      margin: 0 auto;
      gap: 8px;
    }
    .estacao {
      width: 70px;
      height: 70px;
      border-radius: 10px;
      background: #ccc;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: bold;
      margin: 0 1px;
      position: relative;
      font-size: 11px;
      text-align: center;
      line-height: 1.2;
      padding: 5px;
      box-sizing: border-box;
      transition: box-shadow .2s;
    }
    .ativa-trem1 { background: #4caf50; color: #fff; }
    .ativa-trem2 { background: #2196F3; color: #fff; }
    .ativa-trem3 { background: #FFB300; color: #fff; }
    .ativa-trem4 { background: #8BC34A; color: #fff; }
    .ativa-trem5 { background: #E040FB; color: #fff; }

    /* Novas cores para os trens 6,7,8,9,10,16,17,18,19,20 */
    .ativa-trem-vermelha { background-color: #F44336; color: white; }
    .ativa-trem-preta { background-color: #212121; color: white; }
    .ativa-trem-cinza { background-color: #9E9E9E; color: white; }
    .ativa-trem-marrom { background-color: #795548; color: white; }
    .ativa-trem-roxa { background-color: #673AB7; color: white; }
    .ativa-trem-azulclaro { background-color: #03A9F4; color: white; }
    .ativa-trem-verdeescuro { background-color: #388E3C; color: white; }
    .ativa-trem-laranja { background-color: #FF9800; color: white; }
    .ativa-trem-rosa { background-color: #E91E63; color: white; }
    .ativa-trem-amareloescuro { background-color: #FFC107; color: #212121; } /* Texto escuro para contraste */

    .falha {
      background: #f44336 !important;
      color: #fff;
      animation: piscar 0.5s infinite alternate;
    }
    @keyframes piscar {
      from { opacity: 1; }
      to { opacity: 0.7; }
    }
    .trem-parado-msg {
      position: absolute;
      top: +75px;
      left: 50%;
      transform: translateX(-50%);
      background: #222c;
      color: #fff;
      font-size: 11px;
      padding: 2px 6px;
      border-radius: 7px;
      white-space: nowrap;
      z-index: 5;
      pointer-events: none;
      font-weight: bold;
      text-shadow: 0 1px 2px #0006;
    }
    .status {
      margin: 15px auto;
      font-size: 18px;
      font-weight: bold;
      height: 110px;
      display: flex;
      flex-direction: column;
      justify-content: space-between;
    }
    .tempo {
      margin-top: 10px;
      font-style: italic;
      color: #666;
    }
    .controls {
      margin: 20px auto;
      max-width: 1000px;
      padding: 15px;
      background: #ddd;
      border-radius: 10px;
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      gap: 10px;
    }
    button {
      padding: 10px 15px;
      font-size: 14px;
      cursor: pointer;
      min-width: 120px;
      border: none;
      border-radius: 5px;
      font-weight: bold;
    }
    .btn-iniciar {
      background: #4CAF50;
      color: white;
    }
    .btn-parar {
      background: #FF9800;
      color: white;
    }
    .btn-normalizar {
      background: #9C27B0;
      color: white;
    }
    .btn-falha {
      background: #F44336;
      color: white;
    }
    .btn-download {
      background: #607d8b;
      color: white;
    }
    .btn-reset-historico {
      background: #c62828;
      color: white;
    }
    .btn-recolher {
      background: #795548;
      color: white;
    }
    select {
      padding: 8px;
      font-size: 14px;
      border-radius: 5px;
      border: 1px solid #ccc;
    }
    .trem-info {
      display: flex;
      justify-content: center;
      gap: 20px;
      margin: 10px 0;
      flex-wrap: wrap;
    }
    .trem-marker {
      width: 20px;
      height: 20px;
      border-radius: 50%;
      display: inline-block;
      margin-right: 5px;
    }
    .trem1-marker { background: #4caf50; }
    .trem2-marker { background: #2196F3; }
    .trem3-marker { background: #FFB300; }
    .trem4-marker { background: #8BC34A; }
    .trem5-marker { background: #E040FB; }
    .falha-info {
      margin-top: 10px;
      font-size: 14px;
      color: #f44336;
      font-weight: bold;
    }
    .historico-container {
      margin: 35px auto 0 auto;
      background: #fff;
      border-radius: 8px;
      box-shadow: 0 2px 10px #0001;
      padding: 20px;
      max-width: 1100px;
      overflow-x: auto;
    }
    .historico-title {
      font-size: 20px;
      margin-bottom: 10px;
      color: #333;
    }
    #historico-table {
      width: 100%;
      border-collapse: collapse;
      margin: 0 auto;
    }
    #historico-table th, #historico-table td {
      border: 1px solid #bbb;
      padding: 5px 8px;
      font-size: 13px;
      text-align: center;
    }
    #historico-table th {
      background: #e0e0e0;
    }
    #historico-table tr:nth-child(even) {
      background: #f4f4f4;
    }
    .historico-actions {
      display: flex;
      gap: 10px;
      justify-content: flex-end;
      margin-bottom: 10px;
    }
    .via-label {
      font-weight: bold;
      margin-bottom: 5px;
      color: #333;
    }
    @media (max-width: 1200px) {
      .linha { min-width: 900px; }
      .estacao { width: 60px; height: 60px; font-size: 10px; }
    }
    @media (max-width: 900px) {
      .linha { min-width: 600px; }
      .estacao { width: 45px; height: 45px; font-size: 9px; }
    }
    @media (max-width: 700px) {
      .linha-container { padding: 10px 0; }
      .linha { min-width: 400px; }
      .estacao { width: 38px; height: 38px; font-size: 8px;}
    }
  </style>
  
</head>
<body>
  <div class="container">
    <h1>Simulador Linha 5 Lil√°s</h1>
    <div class="via-label">Via 1 - Cap√£o Redondo ‚¨Ö Ch√°cara Klabin</div>
    <div class="linha-container">
      <div class="linha" id="linha-estacoes">
        <div class="estacao" id="est1">Cap√£o<br>Redondo<br>1</div>
        <div class="estacao" id="est2">Campo<br>Limpo</div>
        <div class="estacao" id="est3">Vila das<br>Belezas</div>
        <div class="estacao" id="est4">Giovanni<br>Gronchi</div>
        <div class="estacao" id="est5">Santo<br>Amaro<br>üîÅ 9</div>
        <div class="estacao" id="est6">Largo<br>Treze</div>
        <div class="estacao" id="est7">Adolfo<br>Pinheiro</div>
        <div class="estacao" id="est8">Alto da<br>Boa Vista<br>‚¨á</div>
        <div class="estacao" id="est9">Borba<br>Gato<br>‚¨á</div>
        <div class="estacao" id="est10">Brooklin<br>‚¨á</div>
        <div class="estacao" id="est11">Campo<br>Belo<br>‚¨á</div>
        <div class="estacao" id="est12">Eucaliptos</div>
        <div class="estacao" id="est13">Moema</div>
        <div class="estacao" id="est14">AACD<br>Servidor</div>
        <div class="estacao" id="est15">Hospital<br>S√£o Paulo</div>
        <div class="estacao" id="est16">Santa<br>Cruz<br>üîÅ</div>
        <div class="estacao" id="est17">Ch√°cara<br>Klabin<br>üîÅ 1</div>
      </div>
    </div>
  <div class="linha-container">
      <div class="linha" id="linha-estacoes-via2">
        <div class="estacao" id="est1-v2">Cap√£o<br>Redondo<br>2</div>
        <div class="estacao" id="est2-v2">Campo<br>Limpo</div>
        <div class="estacao" id="est3-v2">Vila das<br>Belezas</div>
        <div class="estacao" id="est4-v2">Giovanni<br>Gronchi</div>
        <div class="estacao" id="est5-v2">Santo<br>Amaro<br>üîÅ 9</div>
        <div class="estacao" id="est6-v2">Largo<br>Treze</div>
        <div class="estacao" id="est7-v2">Adolfo<br>Pinheiro</div>
        <div class="estacao" id="est8-v2">‚¨Ü<br>Alto da<br>Boa Vista</div>
        <div class="estacao" id="est9-v2">‚¨Ü<br>Borba<br>Gato</div>
        <div class="estacao" id="est10-v2">‚¨Ü<br>Brooklin</div>
        <div class="estacao" id="est11-v2">‚¨Ü<br>Campo<br>Belo</div>
        <div class="estacao" id="est12-v2">Eucaliptos</div>
        <div class="estacao" id="est13-v2">Moema</div>
        <div class="estacao" id="est14-v2">AACD<br>Servidor</div>
        <div class="estacao" id="est15-v2">Hospital<br>S√£o Paulo</div>
        <div class="estacao" id="est16-v2">Santa<br>Cruz<br>üîÅ</div>
        <div class="estacao" id="est17-v2">Ch√°cara<br>Klabin<br>üîÅ2</div>
      </div>
    </div>
        <div class="via-label">Via 2 - Cap√£o Redondo ‚û° Ch√°cara Klabin</div>
  
    <div id="status-trens" class="status-container"></div>
    <div class="tempo" id="tempo">Tempo total: 0s</div>
<div id="pote-counter" style="margin: 10px 0; font-size: 18px; font-weight: bold;">
    Trens operando - POT: <span id="pote-value">0</span>/24
</div>
    <div class="controls">
      <label for="potInicial" style="font-weight:bold;">POT inicial:</label>
<input type="number" id="potInicial" min="1" max="24" value="12" style="width:60px; text-align:center; margin-right:10px;">

      <button class="btn-iniciar" onclick="iniciarTrens()">Iniciar Trens</button>
      <button class="btn-parar" id="btnReterTrens" onclick="toggleReterTrens()">Reter Trens</button>
      <button class="btn-normalizar" onclick="normalizarLinha()">Normalizar Linha</button>
      <select id="tremRecolherSelect">
        <option value="">Selecione o trem</option>
        <option value="1">Trem 1</option>
        <option value="2">Trem 2</option>
        <option value="3">Trem 3</option>
        <option value="4">Trem 4</option>
        <option value="5">Trem 5</option>
      </select>
      <button class="btn-recolher" onclick="recolherTrem()">Recolher Trem</button>
      <button class="btn-inserir-trem" onclick="abrirInserirTrem()">Inserir Trem</button>

      <div id="modalInserirTrem" style="display:none; position:fixed; top:0;left:0;width:100vw;height:100vh;z-index:1000;background:#0005;">
        <div style="background:#fff;padding:20px;max-width:320px;margin:60px auto;border-radius:8px;box-shadow:0 4px 20px #0002;position:relative;">
          <h3>Inserir Trem Recolhido</h3>
          <select id="tremInserirSelect" style="margin-bottom:12px;width:100%;">
            <option value="">Selecione um trem</option>
          </select>
          <select id="estacaoInserirSelect" style="margin-bottom:12px;width:100%;">
  <option value="">Selecione a esta√ß√£o</option>
  <option value="capao-v1">Cap√£o Redondo - Via 1</option>
  <option value="capao-v2">Cap√£o Redondo - Via 2</option>
  <option value="santo-v1">Santo Amaro - Via 1</option>
  <option value="santo-v2">Santo Amaro - Via 2</option>
  <option value="klabin-v1">Ch√°cara Klabin - Via 1</option>
  <option value="klabin-v2">Ch√°cara Klabin - Via 2</option>
</select>

          <button onclick="inserirTremRecolhido()" class="btn-inserir-trem" style="margin-right:8px;">Inserir</button>
          <button onclick="fecharInserirTrem()" style="background:#bbb;">Cancelar</button>
        </div>
      </div>
      <select id="falhaTipoSelect">
  <option value="estacao">Falha no Trem</option>
  <option value="trem1">Falha no Trem 1</option>
  <option value="2">Falha no Trem 2</option>
  <option value="3">Falha no Trem 3</option>
  <option value="4">Falha no Trem 4</option>
  <option value="5">Falha no Trem 5</option>
</select>

<select id="falhaSelect">
  <option value="">Selecione uma esta√ß√£o</option>
  <option value="est1">Cap√£o Redondo</option>
  <option value="est2">Campo Limpo</option>
  <option value="est3">Vila das Belezas</option>
  <option value="est4">Giovanni Gronchi</option>
  <option value="est5">Santo Amaro</option>
  <option value="est6">Largo Treze</option>
  <option value="est7">Adolfo Pinheiro</option>
  <option value="est8">Alto da Boa Vista</option>
  <option value="est9">Borba Gato</option>
  <option value="est10">Brooklin</option>
  <option value="est11">Campo Belo</option>
  <option value="est12">Eucaliptos</option>
  <option value="est13">Moema</option>
  <option value="est14">AACD Servidor</option>
  <option value="est15">Hospital S√£o Paulo</option>
  <option value="est16">Santa Cruz</option>
  <option value="est17">Ch√°cara Klabin</option>
</select>

<select id="falhaEstacaoTipo">
  <option value="">Tipo de falha na esta√ß√£o</option>
</select>

<select id="falhaTremTipo">
  <option value="">Tipo de falha no trem</option>
</select>

      <button class="btn-falha" onclick="aplicarFalha()">Aplicar Falha</button>
      <button class="btn-falha" onclick="aplicarFalhaAleatoria()">Falha Aleat√≥ria</button>
      <button class="btn-download" onclick="baixarCSV()">Baixar Hist√≥rico CSV</button>
      <button class="btn-reset-historico" onclick="resetarTudo()">Resetar Tudo</button>
      <button onclick="aumentarPOT()" style="background:#4CAF50; color:white;">+ Trem</button>
<button onclick="diminuirPOT()" style="background:#F44336; color:white;">- Trem</button>

<button class="btn-reset-historico" id="btnSolucao">Solu√ß√£o</button>

    </div>
    <div class="falha-info" id="falha-info"></div>
  </div>
  <div class="historico-container">
    <div class="historico-title">Hist√≥rico de Eventos</div>

    <table id="historico-table">
      <thead>
        <tr>
          <th>#</th>
          <th>Momento (s)</th>
          <th>Evento</th>
          <th>Detalhes</th>
        </tr>
      </thead>
      <tbody id="historico-tbody"></tbody>
    </table>
  </div>
  // Caminho do √°udio (ajustado para pasta local do usu√°rio)
const FALHA_AUDIO_PATH = "DANGER Alarm Sound Effects.mp3"; // Nome do arquivo na mesma pasta do HTML/script

  function iniciarTrens() {
  resetarTudo();

  // N√∫mero de trens a iniciar (POT inicial)
  const potInicial = Number(document.getElementById('potInicial').value) || 12;

  // Combine todas as esta√ß√µes das duas vias
  const todasEstacoes = estacoes_v2.concat(estacoes_v1);
  const totalEstacoes = todasEstacoes.length;

  // Espalhamento: calcular dist√¢ncia m√≠nima entre trens
  const minDistancia = Math.floor(totalEstacoes / potInicial) - 1;

  // Posi√ß√µes poss√≠veis
  let posicoesLivres = [...todasEstacoes];

  // Sorteia as posi√ß√µes de forma espalhada
  let trensPosicoes = [];
  for (let i = 0; i < potInicial; i++) {
    // Para cada trem, escolha uma posi√ß√£o aleat√≥ria dentre as poss√≠veis
    let idx;
    if (posicoesLivres.length === 0) break;
    if (i === 0) {
      // Primeiro trem: posi√ß√£o aleat√≥ria
      idx = Math.floor(Math.random() * posicoesLivres.length);
    } else {
      // Para outros, tente garantir o espa√ßamento m√≠nimo
      let possiveis = posicoesLivres.filter((pos, pIdx) => {
        // Checa a dist√¢ncia dos j√° colocados
        return trensPosicoes.every(tp => {
          let dist = Math.abs(todasEstacoes.indexOf(tp.estacao) - todasEstacoes.indexOf(pos));
          return dist >= minDistancia;
        });
      });
      if (possiveis.length === 0) possiveis = posicoesLivres; // Se n√£o conseguir manter dist√¢ncia, sorteia qualquer
      idx = Math.floor(Math.random() * possiveis.length);
      // Corrige idx para posicoesLivres
      idx = posicoesLivres.indexOf(possiveis[idx]);
    }

    let estacaoEscolhida = posicoesLivres[idx];
    trensPosicoes.push({ estacao: estacaoEscolhida });
    // Remove posi√ß√µes pr√≥ximas do array para aumentar espa√ßamento
    let posIdx = todasEstacoes.indexOf(estacaoEscolhida);
    posicoesLivres = posicoesLivres.filter((pos) => {
      let dist = Math.abs(todasEstacoes.indexOf(pos) - posIdx);
      return dist > minDistancia; // remove esta e pr√≥ximas
    });
  }

  // Inicializa os trens ativos nos locais sorteados
  trensData = [];
  for (let i = 0; i < potInicial; i++) {
    let trem = trens[i];
    let estacao = trensPosicoes[i].estacao;

    // Descobre a via e √≠ndice
    let loopStep, idx;
    if (estacoes_v2.includes(estacao)) {
      loopStep = 0;
      idx = estacoes_v2.indexOf(estacao);
    } else {
      loopStep = 1;
      idx = estacoes_v1.indexOf(estacao);
    }
    trem.ativo = true;
    trem.recolhido = false;
    trem.falha = null;
    trensData.push({
      id: trem.id,
      loopStep,
      idx,
      delay: 0,
      aguardando: false,
      tempoParado: 0,
      tempoParadoEstacao: 0,
      aguardandoProximoTrem: false
    });
  }

  // Os demais trens ficam recolhidos
  for (let i = potInicial; i < trens.length; i++) {
    trens[i].ativo = false;
    trens[i].recolhido = true;
    trens[i].falha = null;
  }

  atualizarLinha();
  atualizarTempo();
  atualizarHistorico();
  atualizarTremRecolherSelect();
  atualizarTremInserirSelect();
  mostrarFalhaInfo();
  atualizarPOTECounter();

  // Inicia o timer da simula√ß√£o
  pararTimer();
  timer = setInterval(avancarSimulacao, 1000);
}
  
function aumentarPOT() {
  // Pega o primeiro trem recolhido (se houver) e reinsere
  if (recolhidos.length > 0) {
    inserirTremRecolhido(recolhidos[0]);
  } else {
    alert("Nenhum trem dispon√≠vel para adicionar.");
  }
}

function diminuirPOT() {
  // Recolhe o √∫ltimo trem ativo
  const tremAtivo = trens.filter(t => t.ativo && !t.recolhido).pop();
  if (tremAtivo) {
    tremAtivo.ativo = false;
    tremAtivo.recolhido = true;
    trensData = trensData.filter(td => td.id !== tremAtivo.id);
    recolhidos.push(tremAtivo.id);
    registrarHistorico(`${tremAtivo.nome} recolhido pelo ajuste do POT`);
    atualizarLinha();
    atualizarTremRecolherSelect();
    atualizarTremInserirSelect();
    atualizarPOTECounter();
  } else {
    alert("Nenhum trem ativo para recolher.");
  }
}

    // ========================== 
// Simulador Linha 5 Lil√°s JS (Ajuste: √Åudio s√≥ para ao normalizar) 
// ========================== 

const falhasTremTextos = [
  "Mal s√∫bito de passageiro",
  "Problema de sinaliza√ß√£o",
  "Reten√ß√£o de portas",
  "Freio acionado pelo CBTC",
  "Bot√£o soco",
  "Sem la√ßo de porta",
  "Intercom ar condicionado",
  "QRU01 Vias de fato",
  "QRU02 Com√©rcio irregular",
  "QRU03 Pedinte",
  "QRU04 Importuna√ß√£o sexual",
  "QRU05 Roubo",
  "QRU06 Furto",
  "QRU07 Arma branca",
  "QRU08 Tumulto",
  "QRU09 Ocorr√™ncia com arma de fogo",
  "Meteoro caiu nos trilhos",
  "Codigo A",
  "Perda de comunica√ß√£o", // Adicionado para ter 24 op√ß√µes
  "Falha no ar condicionado",
  "Portas travadas",
  "Emerg√™ncia a bordo",
  "Colis√£o com objeto",
  "Problema no pant√≥grafo",
  "Inc√™ndio pequeno",
  "Vandalismo",
  "Alfa Bravo",
  "Falha no sistema de freios"
];
const falhasEstacaoTextos = [
  "Mal s√∫bito de passageiro",
  "Queda de energia",
  "Passageiro perdido no sistema",
  "Codigo A",
  "Inc√™ndio na esta√ß√£o", // Adicionado para ter 24 op√ß√µes
  "Port√µes de plataforma com problema",
  "Inunda√ß√£o",
  "Problema na escada rolante",
  "Acesso bloqueado",
  "Fuma√ßa na plataforma",
  "Alarme falso de inc√™ndio",
  "Vazamento de √°gua",
  "Problema na bilheteria",
  "Picha√ß√£o",
  "Esgoto entupido",
  "Sistema de som inoperante",
  "Alarme de emerg√™ncia ativado",
  "Sem luz na esta√ß√£o",
  "Ataque de abelhas",
  "Problema no elevador"
];
  // C√≥digo para inserir o marcador no final da linha
const ultimaEstacao = document.getElementById('est17');

if (ultimaEstacao) {
    const marcadorFim = document.createElement('div');
    marcadorFim.className = 'marcador-central';
    marcadorFim.textContent = 'X 53'; // Voc√™ pode mudar o texto aqui

    ultimaEstacao.parentElement.appendChild(marcadorFim);

    marcadorFim.style.cssText = `
        position: absolute;
        top: 14.4%;
        left: 102%; /* Ajusta a posi√ß√£o para a direita do final da linha */
        transform: translate(-50%, -50%);
        background: #222c;
        color: #fff;
        font-size: 11px;
        padding: 1px 2px;
        border-radius: 7px;
        white-space: nowrap;
        z-index: 5;
        pointer-events: none;
        font-weight: bold;
        text-shadow: 0 1px 2px #0006;
    `;
}
  // C√≥digo para inserir o marcador no in√≠cio da linha
const primeiraEstacao = document.getElementById('est1');

if (primeiraEstacao) {
    const marcadorInicio = document.createElement('div');
    marcadorInicio.className = 'marcador-central';
    marcadorInicio.textContent = 'X40 41'; // Voc√™ pode mudar o texto aqui

    primeiraEstacao.parentElement.insertBefore(marcadorInicio, primeiraEstacao);

    marcadorInicio.style.cssText = `
        position: absolute;
        top: 14.3%;
        left: 2%;
        transform: translate(-50%, -50%);
        background: #222c;
        color: #fff;
        font-size: 11px;
        padding: 1px 2px;
        border-radius: 7px;
        white-space: nowrap;
        z-index: 5;
        pointer-events: none;
        font-weight: bold;
        text-shadow: 0 1px 2px #0006;
    `;
}
  // Fun√ß√£o para inserir um marcador de texto na linha central
function inserirMarcadorCentral(texto, estacaoAnteriorId) {
    const estacaoAnterior = document.getElementById(estacaoAnteriorId);
    if (!estacaoAnterior) return;

    // Criar o elemento do marcador
    const marcador = document.createElement('div');
    marcador.className = 'marcador-central';
    marcador.textContent = texto;

    // Adiciona o marcador ao corpo do documento (ou ao cont√™iner principal)
    document.body.appendChild(marcador);

    // Obt√©m as coordenadas da esta√ß√£o anterior e da pr√≥xima esta√ß√£o
    const estacaoAtual = estacaoAnterior.getBoundingClientRect();
    const proximaEstacao = estacaoAnterior.nextElementSibling ? estacaoAnterior.nextElementSibling.getBoundingClientRect() : null;

    if (!proximaEstacao) return;

    // Calcula a posi√ß√£o central entre as esta√ß√µes
    const centroX = (estacaoAtual.right + proximaEstacao.left) / 2;
    const centroY = (estacaoAtual.top + proximaEstacao.top) / 2;

    // Ajusta o estilo para posicionar o marcador
    marcador.style.cssText = `
        position: absolute;
        left: ${centroX}px;
        top: ${centroY +95}px;
        transform: translate(-50%, -50%);
        background: #222c;
        color: #fff;
        font-size: 11px;
        padding: 1px 2px;
        border-radius: 7px;
        white-space: nowrap;
        z-index: 5;
        pointer-events: none;
        font-weight: bold;
        text-shadow: 0 1px 2px #0006;
    `;
}
// Adiciona o marcador "X" em cada segmento da Via 1
inserirMarcadorCentral('X 42 43 44', 'est1');
inserirMarcadorCentral('X 45 45P', 'est4');
inserirMarcadorCentral('X 46', 'est5');
inserirMarcadorCentral('X 47', 'est6');
inserirMarcadorCentral('X 48', 'est7');


inserirMarcadorCentral('X 49', 'est10');
inserirMarcadorCentral('X 50', 'est11');
inserirMarcadorCentral('X 51', 'est13');

inserirMarcadorCentral('X 52', 'est16');
// 24 trens, j√° prontos para serem espalhados com cores ajustadas
// ===============
const trens = Array.from({
  length: 24
}).map((_, idx) => {
  let corClass = '';
  switch (idx + 1) { // Train IDs are 1-based
    case 1:
      corClass = 'ativa-trem-roxa';
      break;
    case 2:
      corClass = 'ativa-trem-roxa';
      break;
    case 3:
      corClass = 'ativa-trem-roxa';
      break;
    case 4:
      corClass = 'ativa-trem-roxa';
      break;
    case 2:
      corClass = 'ativa-trem-roxa';
      break;
    case 5:
      corClass = 'ativa-trem-roxa';
      break;
    case 6:
      corClass = 'ativa-trem-roxa';
      break;
    case 7:
      corClass = 'ativa-trem-roxa';
      break;
    case 8:
      corClass = 'ativa-trem-roxa';
      break;
    case 9:
      corClass = 'ativa-trem-roxa';
      break;
    case 10:
      corClass = 'ativa-trem-roxa';
      break;
    case 11:
      corClass = 'ativa-trem-roxa';
      break;
    case 12:
      corClass = 'ativa-trem-roxa';
      break;
    case 13:
      corClass = 'ativa-trem-roxa';
      break;
    case 14:
      corClass = 'ativa-trem-roxa';
      break;
    case 15:
      corClass = 'ativa-trem-roxa';
      break;
    case 16:
      corClass = 'ativa-trem-roxa';
      break;
    case 17:
      corClass = 'ativa-trem-roxa';
      break;
    case 18:
      corClass = 'ativa-trem-roxa';
      break;
    case 19:
      corClass = 'ativa-trem-roxa';
      break;
    case 20:
      corClass = 'ativa-trem-roxa';
      break;
    case 21:
      corClass = 'ativa-trem-roxa';
      break;
    case 22:
      corClass = 'ativa-trem-roxa';
      break;
    case 23:
      corClass = 'ativa-trem-roxa';
      break;
    case 24:
      corClass = 'ativa-trem-roxa';
      break;
    default:
      // Para os demais trens, repete as cores existentes ou define novas
      // O objetivo √© ter 24 trens com cores distintas ou que se repitam de forma controlada
      // Vamos fazer com que todos os trens usem a mesma classe de cor roxa
      corClass = 'ativa-trem-roxo'; // Agora todos os trens s√£o roxos
      break;
  }
  return {
    id: idx + 1,
    cor: corClass,
    nome: `Trem ${String(idx + 1).padStart(2, '0')}`,
    delay: 0,
    status: 'Aguardando partida...',
    ativo: true,
    recolhido: false,
    falha: null
  };
});
function atualizarPOTECounter() {
  const trensOperando = trens.filter(t => t.ativo && !t.recolhido).length;
  document.getElementById('pote-value').textContent = trensOperando;
}
const estacoes_v2 = [
  "est1-v2", "est2-v2", "est3-v2", "est4-v2", "est5-v2", "est6-v2", "est7-v2",
  "est8-v2", "est9-v2", "est10-v2", "est11-v2", "est12-v2", "est13-v2", "est14-v2", "est15-v2", "est16-v2", "est17-v2"
];
const estacoes_v1 = [
  "est17", "est16", "est15", "est14", "est13", "est12", "est11", "est10", "est9", "est8", "est7", "est6", "est5", "est4", "est3", "est2", "est1"
];

const LOOP = [
  {
    via: 2,
    estacoes: estacoes_v2,
    sentido: "capao-klabin"
  },
  {
    via: 1,
    estacoes: estacoes_v1,
    sentido: "klabin-capao"
  }
];

let trensData = [];
let tempoTotal = 0;
let timer = null;
let trensReter = false;
let falhaEstacao = null;
let falhaEstacaoTipo = null;
let falhaEstacaoNome = '';
let falhaTrem = {};
let historico = [];
let recolhidos = [];
let inserindoTrem = false;
let falhaMensagem = '';
let falhaAudioIsPlaying = false;

<audio id="falha-audio" src="AUD-20250522-WA0000.mp3" preload="auto"></audio>
// Mapeamento de falhas para solu√ß√µes espec√≠ficas ou aleat√≥rias
const solucoesFalha = {
  // Solu√ß√µes para falhas de trem
  "Bot√£o soco": "Acionar o CCO e informar o carro",
  "Freio acionado pelo CBTC": "Fazer reciclo e informar o CCO",
  // Edi√ß√£o 1: Adicionar solu√ß√µes para falhas de trem aqui
  "Mal s√∫bito de passageiro": "Aguarde edi√ß√£o. Solu√ß√£o: Acionar o CCO, solicitar equipe de seguran√ßa e sa√∫de. O trem s√≥ pode partir com autoriza√ß√£o do CCO. O trem pode ir para o p√°tio, ou continuar a opera√ß√£o, dependendo da avalia√ß√£o m√©dica. Caso o paciente seja retirado, o CCO acionar√° a ambul√¢ncia. A ocorr√™ncia ser√° informada ao Supervisor da Seguran√ßa.",
  "Problema de sinaliza√ß√£o": "Aguarde edi√ß√£o. Solu√ß√£o: Acionar o CCO para receber a instru√ß√£o de condu√ß√£o manual para seguir com o trem em regime de via livre para o pr√≥ximo destino.",
  "Reten√ß√£o de portas": "Aguarde edi√ß√£o. Solu√ß√£o: Abrir e fechar as portas novamente. Se n√£o funcionar, fazer um reciclo. Acionar o CCO e o trem deve seguir com a porta fechada manualmente para o p√°tio.",
  "Sem la√ßo de porta": "Aguarde edi√ß√£o. Solu√ß√£o: Reciclo. Acionar o CCO para receber a instru√ß√£o para seguir em via livre para o p√°tio. Caso a falha persista, solicitar equipe de manuten√ß√£o para apoio.",
  "Intercom ar condicionado": "Aguarde edi√ß√£o. Solu√ß√£o: Acionar o CCO para informar o carro e a falha. O trem deve seguir para o p√°tio para manuten√ß√£o.",
  "QRU01 Vias de fato": "Aguarde edi√ß√£o. Solu√ß√£o: Acionar o CCO e informar o carro. A equipe de seguran√ßa da pr√≥xima esta√ß√£o ir√° intervir e o trem seguir√° a opera√ß√£o.",
  "QRU02 Com√©rcio irregular": "Aguarde edi√ß√£o. Solu√ß√£o: Acionar o CCO e informar o carro. A equipe de seguran√ßa da pr√≥xima esta√ß√£o ir√° intervir. O trem seguir√° a opera√ß√£o. Em casos de agress√£o, pode ser acionada a Pol√≠cia Civil ou Militar. A ocorr√™ncia ser√° informada ao Supervisor da Seguran√ßa.",
  "QRU03 Pedinte": "Aguarde edi√ß√£o. Solu√ß√£o: Acionar o CCO. A equipe de seguran√ßa ir√° agir na pr√≥xima esta√ß√£o. O trem seguir√° a opera√ß√£o.",
  "QRU04 Importuna√ß√£o sexual": "Aguarde edi√ß√£o. Solu√ß√£o: Acionar o CCO e informar o carro. A equipe de seguran√ßa da pr√≥xima esta√ß√£o ir√° intervir e levar as partes para a sala de seguran√ßa para registrar a ocorr√™ncia. O trem seguir√° a opera√ß√£o. A ocorr√™ncia ser√° informada ao Supervisor da Seguran√ßa.",
  "QRU05 Roubo": "Aguarde edi√ß√£o. Solu√ß√£o: Acionar o CCO, informar o carro. A equipe de seguran√ßa ir√° agir na pr√≥xima esta√ß√£o. O trem seguir√° a opera√ß√£o.",
  "QRU06 Furto": "Aguarde edi√ß√£o. Solu√ß√£o: Acionar o CCO, informar o carro. A equipe de seguran√ßa ir√° agir na pr√≥xima esta√ß√£o. O trem seguir√° a opera√ß√£o. A ocorr√™ncia ser√° informada ao Supervisor da Seguran√ßa.",
  "QRU07 Arma branca": "Aguarde edi√ß√£o. Solu√ß√£o: Acionar o CCO, informar o carro. A equipe de seguran√ßa e a Pol√≠cia Militar ir√£o atuar na pr√≥xima esta√ß√£o. O trem seguir√° a opera√ß√£o. A ocorr√™ncia ser√° informada ao Supervisor da Seguran√ßa.",
  "QRU08 Tumulto": "Aguarde edi√ß√£o. Solu√ß√£o: Acionar o CCO, informar o carro. A equipe de seguran√ßa da pr√≥xima esta√ß√£o ir√° intervir. O trem seguir√° a opera√ß√£o. A ocorr√™ncia ser√° informada ao Supervisor da Seguran√ßa.",
  "QRU09 Ocorr√™ncia com arma de fogo": "Aguarde edi√ß√£o. Solu√ß√£o: Acionar o CCO, informar o carro. A equipe de seguran√ßa e a Pol√≠cia Militar ir√£o atuar na pr√≥xima esta√ß√£o. O trem s√≥ pode seguir com autoriza√ß√£o do CCO. A ocorr√™ncia ser√° informada ao Supervisor da Seguran√ßa.",
  "Meteoro caiu nos trilhos": "Aguarde edi√ß√£o. Solu√ß√£o: Acionar o CCO, informar a localiza√ß√£o, e isolar a √°rea. Solicitar a equipe de manuten√ß√£o de via. O trem s√≥ pode seguir com autoriza√ß√£o do CCO.",
  "Codigo A": "Aguarde edi√ß√£o. Solu√ß√£o: Reciclo. Acionar o CCO para receber a instru√ß√£o para seguir em via livre para o p√°tio.",
  "Perda de comunica√ß√£o": "Aguarde edi√ß√£o. Solu√ß√£o: Fazer reciclo para restabelecer comunica√ß√£o. Se n√£o der certo, acionar o CCO para que ele d√™ as instru√ß√µes de condu√ß√£o do trem at√© a pr√≥xima esta√ß√£o ou o p√°tio.",
  "Falha no ar condicionado": "Aguarde edi√ß√£o. Solu√ß√£o: Acionar o CCO e informar o carro. Dependendo da gravidade, o trem pode seguir viagem at√© o p√°tio ou ter que voltar para a origem.",
  "Portas travadas": "Aguarde edi√ß√£o. Solu√ß√£o: Reciclo. Acionar o CCO. Se o trem estiver em opera√ß√£o, ele deve seguir com a porta fechada manualmente para o p√°tio. Se a falha persistir, pode ser necess√°rio solicitar apoio de manuten√ß√£o na pr√≥xima esta√ß√£o ou p√°tio.",
  "Emerg√™ncia a bordo": "Aguarde edi√ß√£o. Solu√ß√£o: Acionar o CCO para receber as instru√ß√µes de atendimento. A equipe de seguran√ßa ir√° intervir na pr√≥xima esta√ß√£o. O trem s√≥ pode seguir com autoriza√ß√£o do CCO.",
  "Colis√£o com objeto": "Aguarde edi√ß√£o. Solu√ß√£o: Acionar o CCO, informar o local da colis√£o e o tipo de objeto. O trem s√≥ pode seguir com a autoriza√ß√£o do CCO. A equipe de manuten√ß√£o ir√° remover o objeto dos trilhos.",
  "Problema no pant√≥grafo": "Aguarde edi√ß√£o. Solu√ß√£o: Acionar o CCO e informar o problema. O trem deve ser recolhido para o p√°tio e o pr√≥ximo trem deve entrar em opera√ß√£o.",
  "Inc√™ndio pequeno": "Aguarde edi√ß√£o. Solu√ß√£o: Acionar o CCO e informar o carro. Em casos de inc√™ndio nos trilhos, o trem deve passar para via livre para o pr√≥ximo destino ou para o p√°tio. O Corpo de Bombeiros √© acionado para o atendimento da ocorr√™ncia.",
  "Vandalismo": "Aguarde edi√ß√£o. Solu√ß√£o: Acionar o CCO para reportar a ocorr√™ncia. A equipe de seguran√ßa ir√° intervir na pr√≥xima esta√ß√£o.",
  "Alfa Bravo": "Aguarde edi√ß√£o. Solu√ß√£o: Acionar o CCO para reportar o ocorrido. Seguir com as instru√ß√µes do CCO. O trem deve seguir para a pr√≥xima esta√ß√£o e ir para o p√°tio.",
  "Falha no sistema de freios": "Aguarde edi√ß√£o. Solu√ß√£o: Acionar o CCO e informar a falha. O trem deve seguir em velocidade reduzida at√© o p√°tio para manuten√ß√£o. O pr√≥ximo trem da linha deve ser o de servi√ßo, para verificar as condi√ß√µes dos trilhos e o funcionamento dos trens. Caso o trem falhado esteja parado na via, deve ser removido para o p√°tio com o apoio de um trem auxiliar.",
  // Edi√ß√£o 2: Adicionar solu√ß√µes para falhas de esta√ß√£o aqui
  "Mal s√∫bito de passageiro": "Aguarde edi√ß√£o. Solu√ß√£o: Acionar o CCO, solicitar equipe de seguran√ßa e ambul√¢ncia. O trem pode seguir a opera√ß√£o, mas o passageiro com mal s√∫bito deve ser levado para a sala de seguran√ßa para aguardar a chegada da ambul√¢ncia.",
  "Queda de energia": "Aguarde edi√ß√£o. Solu√ß√£o: Acionar o CCO, que ir√° restabelecer a energia na esta√ß√£o. As vias devem ser interrompidas at√© que a energia volte. O trem que est√° na esta√ß√£o deve permanecer parado at√© que a energia retorne. Os passageiros devem ser retirados e transportados por √¥nibus. Os trens devem seguir para o p√°tio. Caso a queda de energia seja em toda a linha, o transporte de passageiros √© interrompido.",
  "Passageiro perdido no sistema": "Aguarde edi√ß√£o. Solu√ß√£o: Acionar o CCO para relatar a ocorr√™ncia. A equipe de seguran√ßa deve procurar o passageiro perdido. O trem pode seguir a opera√ß√£o. Caso o passageiro seja encontrado, ele deve ser encaminhado para a sala de seguran√ßa para que a equipe de seguran√ßa entre em contato com a fam√≠lia. O passageiro ser√° orientado a n√£o se perder novamente.",
  "Inc√™ndio na esta√ß√£o": "Aguarde edi√ß√£o. Solu√ß√£o: Acionar o CCO e o Corpo de Bombeiros. Todos os trens que chegarem √† esta√ß√£o devem ser parados antes da esta√ß√£o. Os passageiros da esta√ß√£o devem ser retirados. A opera√ß√£o s√≥ pode ser retomada com a autoriza√ß√£o do CCO.",
  "Port√µes de plataforma com problema": "Aguarde edi√ß√£o. Solu√ß√£o: Acionar o CCO e a equipe de manuten√ß√£o. A esta√ß√£o deve ser isolada at√© que o problema seja resolvido. Os passageiros devem ser retirados. O trem n√£o pode passar por essa esta√ß√£o at√© que o problema seja resolvido.",
  "Inunda√ß√£o": "Aguarde edi√ß√£o. Solu√ß√£o: Acionar o CCO e a equipe de manuten√ß√£o e limpeza. Os trens n√£o podem passar pela esta√ß√£o. Os passageiros devem ser retirados. A opera√ß√£o s√≥ pode ser retomada com a autoriza√ß√£o do CCO.",
  "Problema na escada rolante": "Aguarde edi√ß√£o. Solu√ß√£o: Acionar o CCO e a equipe de manuten√ß√£o. As escadas rolantes devem ser paralisadas e o acesso deve ser bloqueado.",
  "Acesso bloqueado": "Aguarde edi√ß√£o. Solu√ß√£o: Acionar o CCO e a equipe de seguran√ßa para liberar o acesso.",
  "Fuma√ßa na plataforma": "Aguarde edi√ß√£o. Solu√ß√£o: Acionar o CCO. A equipe de seguran√ßa deve evacuar a plataforma. O trem n√£o pode parar na esta√ß√£o at√© que o problema seja resolvido. O Corpo de Bombeiros deve ser acionado.",
  "Alarme falso de inc√™ndio": "Aguarde edi√ß√£o. Solu√ß√£o: Acionar o CCO para relatar o ocorrido. As vias de acesso e os trens podem ser liberados para opera√ß√£o.",
  "Vazamento de √°gua": "Aguarde edi√ß√£o. Solu√ß√£o: Acionar o CCO e a equipe de manuten√ß√£o. O local do vazamento deve ser isolado. O trem pode seguir a opera√ß√£o, mas a esta√ß√£o deve ser isolada at√© que o problema seja resolvido.",
  "Problema na bilheteria": "Aguarde edi√ß√£o. Solu√ß√£o: Acionar o CCO e a equipe de manuten√ß√£o para reparar a bilheteria.",
  "Picha√ß√£o": "Aguarde edi√ß√£o. Solu√ß√£o: Acionar o CCO e a equipe de limpeza. O local deve ser limpo e a seguran√ßa deve ser refor√ßada.",
  "Esgoto entupido": "Aguarde edi√ß√£o. Solu√ß√£o: Acionar o CCO e a equipe de manuten√ß√£o e limpeza para desentupir o esgoto.",
  "Sistema de som inoperante": "Aguarde edi√ß√£o. Solu√ß√£o: Acionar o CCO e a equipe de manuten√ß√£o para reparar o sistema de som.",
  "Alarme de emerg√™ncia ativado": "Aguarde edi√ß√£o. Solu√ß√£o: Acionar o CCO e a equipe de seguran√ßa para verificar o motivo do acionamento do alarme. Se for falso, liberar o acesso.",
  "Sem luz na esta√ß√£o": "Aguarde edi√ß√£o. Solu√ß√£o: Acionar o CCO, que ir√° restabelecer a energia na esta√ß√£o. A opera√ß√£o dos trens pode seguir normalmente, mas a esta√ß√£o deve ter o acesso isolado at√© que a energia retorne.",
  "Ataque de abelhas": "Aguarde edi√ß√£o. Solu√ß√£o: Acionar o CCO e o Corpo de Bombeiros. A esta√ß√£o deve ser isolada. O trem pode passar pela esta√ß√£o, mas n√£o pode parar. A opera√ß√£o s√≥ pode ser retomada com a autoriza√ß√£o do CCO. Os passageiros devem ser retirados para a √°rea de seguran√ßa. Caso haja feridos, o CCO acionar√° a ambul√¢ncia.",
  "Problema no elevador": "Aguarde edi√ß√£o. Solu√ß√£o: Acionar o CCO e a equipe de manuten√ß√£o. O elevador deve ser isolado.",
};
const opcoesSolucao = [
  "Acionar o CCO e informar o carro",
  "Fazer reciclo e informar o CCO"
];

function resetarTudo() {
  pararTimer();
  trensData = [];
  for (const t of trens) {
    t.status = 'Aguardando partida...';
    t.ativo = true;
    t.recolhido = false;
    t.falha = null;
  }
  tempoTotal = 0;
  trensReter = false;
  falhaEstacao = null;
  falhaEstacaoTipo = null;
  falhaEstacaoNome = '';
  falhaTrem = {};
  recolhidos = [];
  inserindoTrem = false;
  historico = [];
  falhaMensagem = '';


  atualizarLinha();
  atualizarTempo();
  atualizarHistorico();
  mostrarFalhaInfo();
  document.getElementById('btnReterTrens').textContent = 'Reter Trens';
  atualizarTremRecolherSelect();
  atualizarTremInserirSelect();
  pararAudioFalha(); // NOVO: para sempre ao resetar/normalizar
  atualizarPOTECounter(); // Atualiza o contador POTE
}

function atualizarTempo() {
  document.getElementById('tempo').textContent = `Tempo total: ${tempoTotal}s`;
}


function atualizarLinha() {
  estacoes_v2.concat(estacoes_v1).forEach(e => {
    const el = document.getElementById(e);
    if (el) {
      el.className = 'estacao';
      let c = el.childNodes;
      for (let i = c.length - 1; i >= 0; i--) {
        if (c[i].classList && (c[i].classList.contains('trem-parado-msg') || c[i].classList.contains('trem-nome-label') || c[i].classList.contains('trem-num-label'))) {
          el.removeChild(c[i]);
        }
      }
    }
  });
  if (falhaEstacao) {
    const el = document.getElementById(falhaEstacao);
    if (el) el.classList.add('falha');
    const el2 = document.getElementById(falhaEstacao.replace('-v2', ''));
    if (el2) el2.classList.add('falha');
  }
  let ocupacao = {}; // This is not strictly used for rendering, but for logic
  for (const trem of trens) {
    if (!trem.ativo || trem.recolhido) continue;
    const tremData = trensData.find(td => td.id === trem.id);
    if (!tremData) continue;
    let loopStep = tremData.loopStep;
    let idx = tremData.idx;
    let viaArr = LOOP[loopStep].estacoes;
    let est = viaArr[idx];
    ocupacao[est] = trem.id;
  }
  for (const trem of trens) {
    if (!trem.ativo || trem.recolhido) continue;
    const tremData = trensData.find(td => td.id === trem.id);
    if (!tremData) continue;
    let loopStep = tremData.loopStep;
    let idx = tremData.idx;
    let viaArr = LOOP[loopStep].estacoes;
    let est = viaArr[idx];
    const el = document.getElementById(est);
    if (el) {
      el.classList.add(trem.cor);
      let numLabel = document.createElement('div');
      numLabel.className = "trem-num-label";
      numLabel.style.cssText = "position:absolute;top:-19px;left:10%;transform:translateX(-60%);background:#fff8;padding:2px 8px;border-radius:8px;font-weight:bold;font-size:14px;color:#222;border:1px solid #bbb;z-index:11;";
      numLabel.textContent = ` T ${trem.id.toString().padStart(2, '0')}`;
      el.appendChild(numLabel);
      if (trem.falha) {
        inserirParadoMsg(el, trem.falha);
      } else if (trensReter) {
        inserirParadoMsg(el, 'Retido');
      } else if (falhaEstacao && est.replace('-v2', '') === falhaEstacao.replace('-v2', '')) {
        inserirParadoMsg(el, falhaEstacaoTipo || 'Falha Esta√ß√£o');
      } else if (tremData.aguardandoProximoTrem) { // Display message when waiting for next train
        inserirParadoMsg(el, 'Aguardando');
      }
    }
  }
}

function inserirParadoMsg(el, msg) {
  if (!el.querySelector('.trem-parado-msg')) {
    let div = document.createElement('div');
    div.className = 'trem-parado-msg';
    div.textContent = msg;
    el.appendChild(div);
  }
}

// Fun√ß√£o para espalhar os trens nas esta√ß√µes
function obterPosicoesIniciaisTrens() {
  const totalEstacoes = estacoes_v2.length + estacoes_v1.length;
  let posicoes = [];
  let ocupadas = new Set(); // Store occupied positions as "loopStep_idx"

  const numTracks = LOOP.length;

  for (let i = 0; i < trens.length; i++) {
    let bestLoopStep = -1;
    let bestIdx = -1;
    let maxDistance = -1;

    // Iterate through all possible starting positions to find the "freest" one
    for (let ls = 0; ls < numTracks; ls++) {
      const estacoesArr = LOOP[ls].estacoes;
      for (let j = 0; j < estacoesArr.length; j++) {
        const currentPosKey = `${ls}_${j}`;
        if (!ocupadas.has(currentPosKey)) {
          // Calculate distance to nearest occupied spot on this track
          let minDist = Infinity;
          for (let k = 0; k < estacoesArr.length; k++) {
            if (ocupadas.has(`${ls}_${k}`)) {
              minDist = Math.min(minDist, Math.abs(j - k));
            }
          }
          if (minDist === Infinity) minDist = estacoesArr.length; // If no other trains on track

          if (minDist > maxDistance) {
            maxDistance = minDist;
            bestLoopStep = ls;
            bestIdx = j;
          }
        }
      }
    }
    // If we couldn't find an ideal spot, just take the first available
    if (bestLoopStep === -1) {
      // Fallback: simply find the first available spot
      for (let ls = 0; ls < numTracks; ls++) {
        const estacoesArr = LOOP[ls].estacoes;
        for (let j = 0; j < estacoesArr.length; j++) {
          const currentPosKey = `${ls}_${j}`;
          if (!ocupadas.has(currentPosKey)) {
            bestLoopStep = ls;
            bestIdx = j;
            break;
          }
        }
        if (bestLoopStep !== -1) break;
      }
    }

    if (bestLoopStep !== -1) {
      posicoes.push({
        loopStep: bestLoopStep,
        idx: bestIdx
      });
      ocupadas.add(`${bestLoopStep}_${bestIdx}`);
    } else {
      // This should ideally not happen if there are enough stations
      console.warn("Could not find a unique starting position for a train.");
      // Assign a default if no space is found (e.g., first station)
      posicoes.push({
        loopStep: 0,
        idx: 0
      });
    }
  }
  return posicoes;
}






function pararTimer() {
  if (timer) clearInterval(timer);
  timer = null;
}


function estacaoOcupada(loopStep, idx, tremId) {
  for (const trem of trens) {
    if (!trem.ativo || trem.recolhido || trem.id === tremId) continue;
    const data = trensData.find(td => td.id === trem.id);
    if (!data) continue;
    if (data.loopStep === loopStep && data.idx === idx) {
      return true;
    }
  }
  return false;
}


function proximaPosicaoOcupada(loopStep, idx, tremId) {
  const currentLoop = LOOP[loopStep];
  const estacoesArr = currentLoop.estacoes;

  // Case 1: Moving within the same track
  if (idx < estacoesArr.length - 1) {
    return estacaoOcupada(loopStep, idx + 1, tremId);
  }

  // Case 2: At the end of the current track, check the first station of the next track
  if (idx === estacoesArr.length - 1) {
    const nextLoopStep = (loopStep + 1) % LOOP.length;
    const nextLoopFirstStationIdx = 0; // First station of the next loop
    return estacaoOcupada(nextLoopStep, nextLoopFirstStationIdx, tremId);
  }
  return false;
}


function avancarSimulacao() {
  tempoTotal++;
  for (const trem of trens) {
    if (!trem.ativo || trem.recolhido) continue;
    const data = trensData.find(td => td.id === trem.id);
    if (!data) continue;


    data.aguardandoProximoTrem = false; // Reset this flag at the beginning of each tick


    if (data.delay > 0) {
      data.delay--;
      trem.status = `Aguardando partida (${data.delay}s)`;
      continue;
    }
    if (trem.falha) {
      trem.status = `Parado por falha (${trem.falha})`;
      continue;
    }
    let loopStep = data.loopStep;
    let estacoesArr = LOOP[loopStep].estacoes;
    if (falhaEstacao && estacoesArr[data.idx] === falhaEstacao) {
      trem.status = `Parado em ${formatarEstacao(estacoesArr[data.idx])} (${falhaEstacaoTipo})`;
      data.tempoParado++;
      data.tempoParadoEstacao = 0;
      continue;
    }
    if (trensReter) {
      trem.status = `Parado em ${formatarEstacao(estacoesArr[data.idx])} (Retido)`;
      data.tempoParado++;
      data.tempoParadoEstacao = 0;
      continue;
    }


    // NEW: Check if the *next* station (considering loop change) is occupied
    if (!data.aguardando && proximaPosicaoOcupada(loopStep, data.idx, trem.id)) {
      trem.status = `Aguardando libera√ß√£o da pr√≥xima esta√ß√£o`;
      data.tempoParadoEstacao = 0;
      data.aguardandoProximoTrem = true; // Set flag
      continue;
    }


    if (typeof data.tempoParadoEstacao !== "number") data.tempoParadoEstacao = 0;
    if (data.tempoParadoEstacao < 3) {
      data.tempoParadoEstacao++;
      trem.status = `Parado na esta√ß√£o ${formatarEstacao(estacoesArr[data.idx])} (${data.tempoParadoEstacao}/3s)`;
      continue;
    }
    trem.status = `Em ${formatarEstacao(estacoesArr[data.idx])}`;
    if (!data.aguardando) {
      if (data.idx < estacoesArr.length - 1) {
        // This is where the train moves to the next station
        data.idx++;
        data.tempoParadoEstacao = 0;
      } else {
        // End of the line, switch loop and reset index
        data.loopStep = (data.loopStep + 1) % LOOP.length;
        data.idx = 0;
        trem.status = 'Aguardando retorno...';
        data.aguardando = true;
        data.tempoParadoEstacao = 0;
        registrarHistorico(`${trem.nome} chegou ao fim do trecho (${LOOP[data.loopStep].via === 2 ? "Cap√£o via 2 ‚Üí Klabin via 2" : "Klabin via 1 ‚Üí Cap√£o via 1"})`);
      }
    } else {
      if (!data.retPause) data.retPause = 1;
      else data.retPause++;
      if (data.retPause > 4) { // Pause for 4 seconds at the end of the line before returning
        data.aguardando = false;
        data.idx = 0; // Reset index to 0 for the new loop
        data.retPause = 0;
        data.tempoParadoEstacao = 0;
        registrarHistorico(`${trem.nome} iniciando pr√≥ximo trecho do loop`);
      }
    }
  }
  atualizarLinha();


  atualizarTempo();
}


function toggleReterTrens() {
  trensReter = !trensReter;
  document.getElementById('btnReterTrens').textContent = trensReter ? 'Retomar Trens' : 'Reter Trens';
  registrarHistorico(trensReter ? 'Trens retidos na linha' : 'Trens retomados');
  atualizarLinha();
}


function normalizarLinha() {
  for (const t of trens) t.falha = null;
  falhaEstacao = null;
  falhaEstacaoTipo = null;
  falhaMensagem = '';
  mostrarFalhaInfo();
  registrarHistorico('Linha normalizada');
  atualizarLinha();


  pararAudioFalha(); // NOVO: para o √°udio ao normalizar
}


function aplicarFalha() {
  // Vincule todos os bot√µes de falha a esta fun√ß√£o
  falha();
}


function aplicarFalhaAleatoria() {
  if (Math.random() < 0.5) {
    const idx = Math.floor(Math.random() * estacoes_v2.length);
    const tipoIdx = Math.floor(Math.random() * falhasEstacaoTextos.length);
    falhaEstacao = estacoes_v2[idx];
    falhaEstacaoTipo = falhasEstacaoTextos[tipoIdx];
    falhaMensagem = `Falha aleat√≥ria em ${formatarEstacao(falhaEstacao)}: ${falhaEstacaoTipo}`;
    registrarHistorico(`Falha aleat√≥ria esta√ß√£o: ${formatarEstacao(falhaEstacao)} (${falhaEstacaoTipo})`);
  } else {
    const tremId = Math.floor(Math.random() * trens.length) + 1; // Randomly select from 24 trens
    const tipoIdx = Math.floor(Math.random() * falhasTremTextos.length);
    let trem = trens.find(t => t.id === tremId);
    if (trem) {
      trem.falha = falhasTremTextos[tipoIdx];
      falhaMensagem = `Falha aleat√≥ria no ${trem.nome}: ${falhasTremTextos[tipoIdx]}`;
      registrarHistorico(`Falha aleat√≥ria ${trem.nome}: ${falhasTremTextos[tipoIdx]}`);
    }
  }
  tocarAudioFalhaLoop();
  mostrarFalhaInfo();
  atualizarLinha();


}


// TOCAR √ÅUDIO EM LOOP AT√â NORMALIZAR
function tocarAudioFalhaLoop() {
  let audio = document.getElementById('falha-audio');
  if (!audio) {
    audio = document.createElement('audio');
    audio.id = 'falha-audio';
    audio.src = FALHA_AUDIO_PATH;
    audio.loop = true;
    document.body.appendChild(audio);
  }
  audio.loop = true;
  try {
    audio.currentTime = 0;
    audio.play();
    falhaAudioIsPlaying = true;
  } catch (e) {}
}


function pararAudioFalha() {
  let audio = document.getElementById('falha-audio');
  if (audio) {
    audio.pause();
    audio.currentTime = 0;
    falhaAudioIsPlaying = false;
  }
}


function recolherTrem() {
  const tremValor = document.getElementById('tremRecolherSelect').value;
  if (!tremValor) return alert('Selecione o trem para recolher');

  if (tremValor === 'todos') {
    const trensParaRecolher = trens.filter(t => t.ativo && !t.recolhido);
    if (!trensParaRecolher.length) {
      alert('N√£o h√° trens para recolher.');
      return;
    }


    trensParaRecolher.forEach(trem => {
      trem.ativo = false;
      trem.recolhido = true;
      trem.falha = null;
      trensData = trensData.filter(td => td.id !== trem.id);
      if (!recolhidos.includes(trem.id)) {
        recolhidos.push(trem.id);
      }
      registrarHistorico(`${trem.nome} recolhido`);
    });


  } else {
    const tremNum = Number(tremValor);
    const trem = trens.find(t => t.id === tremNum);
    if (!trem) return;


    trem.ativo = false;
    trem.recolhido = true;
    trem.falha = null;
    trensData = trensData.filter(td => td.id !== tremNum);
    if (!recolhidos.includes(tremNum)) {
      recolhidos.push(tremNum);
    }
    registrarHistorico(`${trem.nome} recolhido`);
  }


  atualizarTremRecolherSelect();
  atualizarTremInserirSelect();


  atualizarLinha();
  atualizarPOTECounter(); // Atualiza o contador POTE
}


function atualizarTremRecolherSelect() {
  const select = document.getElementById('tremRecolherSelect');
  select.innerHTML = `<option value="">Selecione um trem</option>`;
  // Op√ß√£o para recolher todos
  select.innerHTML += `<option value="todos">Todos os trens</option>`;
  // Somente os trens ativos e n√£o recolhidos
  trens.filter(t => t.ativo && !t.recolhido).forEach(trem => {
    select.innerHTML += `<option value="${trem.id}">${trem.nome}</option>`;
  });
}


function abrirInserirTrem() {
  if (!recolhidos.length) return alert('Nenhum trem recolhido dispon√≠vel para inserir');
  document.getElementById('modalInserirTrem').style.display = 'block';
  atualizarTremInserirSelect();
}


function fecharInserirTrem() {
  document.getElementById('modalInserirTrem').style.display = 'none';
}


function atualizarTremInserirSelect() {
  const select = document.getElementById('tremInserirSelect');
  select.innerHTML = `<option value="">Selecione um trem</option>`;
  // Sort recolhidos by ID for consistent display
  recolhidos.sort((a, b) => a - b).forEach(n => {
    const trem = trens.find(t => t.id === n);
    if (trem) {
      select.innerHTML += `<option value="${n}">${trem.nome}</option>`;
    }
  });
}

function inserirTremRecolhido(tremNumToInsert = null) {
  let tremNum = tremNumToInsert ? tremNumToInsert : Number(document.getElementById('tremInserirSelect').value);
  let estacaoEscolhida = document.getElementById('estacaoInserirSelect').value;

  if (!tremNum) return alert('Selecione o trem para inserir');
  if (!estacaoEscolhida) return alert('Selecione a esta√ß√£o de inser√ß√£o');

  const trem = trens.find(t => t.id === tremNum);
  if (!trem || !trem.recolhido) return;

  trem.ativo = true;
  trem.recolhido = false;
  trem.falha = null;

  let newLoopStep = 0;
  let newIdx = 0;

  switch (estacaoEscolhida) {
    case "capao-v1":
      newLoopStep = 1; newIdx = estacoes_v1.indexOf("est1"); break;
    case "capao-v2":
      newLoopStep = 0; newIdx = estacoes_v2.indexOf("est1-v2"); break;
    case "santo-v1":
      newLoopStep = 1; newIdx = estacoes_v1.indexOf("est5"); break;
    case "santo-v2":
      newLoopStep = 0; newIdx = estacoes_v2.indexOf("est5-v2"); break;
    case "klabin-v1":
      newLoopStep = 1; newIdx = estacoes_v1.indexOf("est17"); break;
    case "klabin-v2":
      newLoopStep = 0; newIdx = estacoes_v2.indexOf("est17-v2"); break;
    default:
      alert("Esta√ß√£o inv√°lida"); return;
  }

  trensData.push({
    id: trem.id,
    loopStep: newLoopStep,
    idx: newIdx,
    delay: 0,
    aguardando: false,
    tempoParado: 0,
    tempoParadoEstacao: 0,
    aguardandoProximoTrem: false
  });

  recolhidos = recolhidos.filter(n => n !== tremNum);
  fecharInserirTrem();
  registrarHistorico(`${trem.nome} inserido em ${estacaoEscolhida}`);
  atualizarLinha();
  atualizarTremRecolherSelect();
  atualizarTremInserirSelect();
  atualizarPOTECounter();
}





function formatarEstacao(est) {
  switch (est.replace('-v2', '')) {
    case 'est1':
      return 'Cap√£o Redondo';
    case 'est2':
      return 'Campo Limpo';
    case 'est3':
      return 'Vila das Belezas';
    case 'est4':
      return 'Giovanni Gronchi';
    case 'est5':
      return 'Santo Amaro';
    case 'est6':
      return 'Largo Treze';
    case 'est7':
      return 'Adolfo Pinheiro';
    case 'est8':
      return 'Alto da Boa Vista';
    case 'est9':
      return 'Borba Gato';
    case 'est10':
      return 'Brooklin';
    case 'est11':
      return 'Campo Belo';
    case 'est12':
      return 'Eucaliptos';
    case 'est13':
      return 'Moema';
    case 'est14':
      return 'AACD Servidor';
    case 'est15':
      return 'Hospital S√£o Paulo';
    case 'est16':
      return 'Santa Cruz';
    case 'est17':
      return 'Ch√°cara Klabin';
    default:
      return est;
  }
}


function registrarHistorico(evento, detalhes = '') {
  historico.unshift({
    tempo: tempoTotal,
    evento,
    detalhes
  });
  atualizarHistorico();
}

// Edi√ß√£o 3: Adicionar falhas de esta√ß√£o no hist√≥rico
function formatarFalha(falhaTipo, falhaLocal) {
    return `Falha em ${falhaLocal}: ${falhaTipo}`;
}
// Final da Edi√ß√£o 3

function atualizarHistorico() {
  const tbody = document.getElementById('historico-tbody');
  tbody.innerHTML = '';
  historico.forEach((e, i) => {
    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${historico.length - i}</td><td>${e.tempo}s</td><td>${e.evento}</td><td>${e.detalhes||''}</td>`;
    tbody.appendChild(tr);
  });
}


function baixarCSV() {
  if (!historico.length) return alert('Sem hist√≥rico para exportar!');
  let csv = 'ID,Momento (s),Evento,Detalhes\n';
  historico.slice().reverse().forEach((e, i) => {
    csv += `${i+1},${e.tempo},"${e.evento}","${e.detalhes||''}"\n`;
  });
  const blob = new Blob([csv], {
    type: 'text/csv'
  });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = 'historico_linha5.csv';
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
  URL.revokeObjectURL(url);
}


function mostrarFalhaInfo() {
  document.getElementById('falha-info').textContent = falhaMensagem;
  document.getElementById('falha-info').style.color = '#f44336';
}


// ===============
// Fun√ß√£o para o bot√£o Falha
// ===============
function falha() {
  // Obt√©m o valor selecionado para tipo de falha (esta√ß√£o ou trem)
  const tipo = document.getElementById('falhaTipoSelect').value;
  if (tipo === 'estacao') {
    // Falha em esta√ß√£o
    const est = document.getElementById('falhaSelect').value;
    const tipoFalhaEst = document.getElementById('falhaEstacaoTipo').value;
    if (!est || !tipoFalhaEst) {
      alert('Selecione a esta√ß√£o e o tipo de falha');
      return;
    }
    falhaEstacao = est;
    falhaEstacaoTipo = tipoFalhaEst;
    falhaMensagem = `Falha em esta√ß√£o: ${formatarEstacao(est)} - ${tipoFalhaEst}`;
    tocarAudioFalhaLoop();
    registrarHistorico(`Falha em esta√ß√£o: ${formatarEstacao(est)} (${tipoFalhaEst})`);
  } else if (tipo && tipo.startsWith('trem')) {
    // Falha em trem
    const tremId = Number(tipo.replace('trem', ''));
    const tipoFalhaTrem = document.getElementById('falhaTremTipo').value;
    if (!tremId || !tipoFalhaTrem) {
      alert('Selecione um trem e tipo de falha');
      return;
    }
    let trem = trens.find(t => t.id === tremId);
    if (trem) {
      trem.falha = tipoFalhaTrem;
      falhaMensagem = `Falha no ${trem.nome}: ${tipoFalhaTrem}`;
      tocarAudioFalhaLoop();
      registrarHistorico(`Falha no ${trem.nome}: ${tipoFalhaTrem}`);
    }
  } else {
    alert('Selecione o tipo de falha');
    return;
  }
  mostrarFalhaInfo();
  atualizarLinha();


}
// Edi√ß√£o 4: Reorganizar a fun√ß√£o solucionarFalha
function solucionarFalha() {
  // Verifica se h√° falha de trem
  const tremComFalha = trens.find(t => t.falha !== null);
  if (tremComFalha) {
    const falhaTipo = tremComFalha.falha;
    let solucao = solucoesFalha[falhaTipo] || opcoesSolucao[Math.floor(Math.random() * opcoesSolucao.length)];
    alert(`Solu√ß√£o para a falha de trem "${falhaTipo}" no ${tremComFalha.nome}:\n\n${solucao}`);
    registrarHistorico(`Solu√ß√£o aplicada para o ${tremComFalha.nome}: ${falhaTipo}`, solucao);
    tremComFalha.falha = null;
  }
  
  // Verifica se h√° falha de esta√ß√£o
  else if (falhaEstacao) {
    const falhaEstacaoTipoEncontrada = falhaEstacaoTipo;
    const estacaoNome = formatarEstacao(falhaEstacao);
    let solucao = solucoesFalha[falhaEstacaoTipoEncontrada] || opcoesSolucao[Math.floor(Math.random() * opcoesSolucao.length)];
    alert(`Solu√ß√£o para a falha de esta√ß√£o "${falhaEstacaoTipoEncontrada}" em ${estacaoNome}:\n\n${solucao}`);
    registrarHistorico(`Solu√ß√£o aplicada para a esta√ß√£o ${estacaoNome}: ${falhaEstacaoTipoEncontrada}`, solucao);
    falhaEstacao = null;
    falhaEstacaoTipo = null;
  }
  
  else {
    alert('Nenhuma falha para solucionar.');
    return;
  }

  // **NOVO: Parar o √°udio quando a solu√ß√£o √© aplicada**
  pararAudioFalha();

  falhaMensagem = '';
  mostrarFalhaInfo();
  atualizarLinha();
}
// Final da Edi√ß√£o 4
// ===============
// Adicione event listeners para todos os bot√µes que causam falha
// ===============
window.onload = function() {
  let falhaTremTipo = document.getElementById('falhaTremTipo');
  if (falhaTremTipo) {
    falhaTremTipo.innerHTML = '<option value="">Tipo de falha no trem</option>' + falhasTremTextos.map(f => `<option value="${f}">${f}</option>`).join('');
  }
  let falhaEstacaoTipo = document.getElementById('falhaEstacaoTipo');
  if (falhaEstacaoTipo) {
    falhaEstacaoTipo.innerHTML = '<option value="">Tipo de falha na esta√ß√£o</option>' + falhasEstacaoTextos.map(f => `<option value="${f}">${f}</option>`).join('');
  }

  // Populate falhaTipoSelect with all 24 trains
  const falhaTipoSelect = document.getElementById('falhaTipoSelect');
  if (falhaTipoSelect) {
    // Clear existing options, but keep the 'estacao' one if it exists
    const existingOptions = Array.from(falhaTipoSelect.options).filter(opt => opt.value === 'estacao' || opt.value === '');
    falhaTipoSelect.innerHTML = '';
    existingOptions.forEach(opt => falhaTipoSelect.appendChild(opt));


    trens.forEach(trem => {
      const option = document.createElement('option');
      option.value = `trem${trem.id}`;
      option.textContent = trem.nome;
      falhaTipoSelect.appendChild(option);
    });
  }


  atualizarLinha();
  atualizarTempo();
  atualizarHistorico();
  atualizarTremRecolherSelect();
  atualizarTremInserirSelect();
  mostrarFalhaInfo();
  atualizarPOTECounter(); // Inicializa o contador POTE


  // Bot√£o principal de falha
  const btnFalha = document.getElementById('btnFalha');
  if (btnFalha) btnFalha.onclick = falha;


  // Vincule os outros bot√µes relevantes para causar falha
  const btnFalhaEstacao = document.getElementById('btnFalhaEstacao');
  if (btnFalhaEstacao) btnFalhaEstacao.onclick = falha;


  const btnFalhaTrem = document.getElementById('btnFalhaTrem');
  if (btnFalhaTrem) btnFalhaTrem.onclick = falha;


  const selectEstacao = document.getElementById('falhaSelect');
  if (selectEstacao) selectEstacao.onchange = function() {
    if (document.getElementById('falhaTipoSelect').value === 'estacao') {
      // Se o usu√°rio selecionar uma esta√ß√£o e o tipo for esta√ß√£o, j√° pode disparar a fun√ß√£o falha (opcional)
      // falha();
    }
  };


  // Add event listener for "Inserir Todos" button
  const btnInserirTodos = document.getElementById('btnInserirTodos'); // You need to add this button in your HTML
  if (btnInserirTodos) {
    btnInserirTodos.onclick = inserirTodosTrensRecolhidos;
  }

  // Adiciona o listener para o novo bot√£o de solu√ß√£o, se existir
  const btnSolucao = document.getElementById('btnSolucao');
  if (btnSolucao) {
    btnSolucao.onclick = solucionarFalha;
  }

};


window.onclick = function(e) {
  if (e.target && e.target.id === 'modalInserirTrem') {
    fecharInserirTrem();
  }
}
  </script>
  <footer style="position: fixed; right: 0; bottom: 0; padding: 10px; background: transparent; font-family: sans-serif;">
    <span style="font-size: 14px; color: #444;">Simulador</span>
  </footer>
</body>
</html>
